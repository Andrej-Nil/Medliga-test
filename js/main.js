class Service {
  constructor() {
  }
  testData = {
    products: [
      {
        id: 0,
        title: 'Hitachi Arietta 850',
        brand: './img/image/brand.png',
        link: '#!',
        price: { old: '10 000 000 ₽', current: '8 000 000 ₽' },
        sale: '20%',
        size_sale: '170 000  ₽',
        stickers: [
          './img/icon/1.png',
          './img/icon/2.png',
          './img/icon/3.png'
        ],
        property: [
          { label: 'Вид оборудования', value: 'УЗИ аппарат' },
          { label: 'Производитель', value: 'Mindray' },
          { label: 'Тип', value: 'Портативный' },
          { label: 'Класс', value: 'Высокий' },
        ],
        img: [
          './img/image/pic2.png',
          './img/image/pic1.png',
          './img/image/pic3.png',
          './img/image/pic4.png',
          './img/image/pic5.png',
        ],
        desc: 'Портативная переносная система цветной допплерографии М7 отличается самой высокой функциональностью. УЗ-сканер M7 оснащен специальным пакетом опций для кардиологических обследований и программным обеспечением для организации рабочего процесса. Является идеальным выбором для профессионалов, ставящих качество'
      },

      {
        id: 1,
        title: 'Ультразвуковая диагностическая система Mindray DC-60 Exp',
        brand: './img/image/brand.png',
        link: '#!',
        price: { old: '7 000 000 ₽', current: 'от 1 990 580 ₽' },
        sale: '20%',
        size_sale: '120 900 ₽',
        stickers: [
          './img/icon/1.png',
          './img/icon/2.png'
        ],
        property: [
          { label: 'Вид оборудования', value: 'УЗИ аппарат' },
          { label: 'Производитель', value: 'Mindray' },
          { label: 'Тип', value: 'Портативный' },
          { label: 'Класс', value: 'Высокий' },
        ],
        img: [
          './img/image/pic1.png',
          './img/image/pic2.png',
          './img/image/pic3.png',
          './img/image/pic4.png',
          './img/image/pic5.png',
        ],
        desc: 'Портативная переносная система цветной допплерографии М7 отличается самой высокой функциональностью. УЗ-сканер M7 оснащен специальным пакетом опций для кардиологических обследований и программным обеспечением для организации рабочего процесса. Является идеальным выбором для профессионалов, ставящих качество'
      },

      {
        id: 2,
        title: 'УЗИ аппарат Mindray M5 new ',
        brand: './img/image/brand.png',
        link: '#!',
        price: { old: '11 000 000 ₽', current: '9 000 000 ₽' },
        sale: '20%',
        stickers: [
          './img/icon/2.png',
          './img/icon/1.png',
          './img/icon/3.png'
        ],
        property: [
          { label: 'Вид оборудования', value: 'УЗИ аппарат' },
          { label: 'Производитель', value: 'Mindray' },
          { label: 'Тип', value: 'Портативный' },
          { label: 'Класс', value: 'Высокий' },
        ],
        img: [
          './img/image/pic4.png',
          './img/image/pic5.png',
          './img/image/pic1.png',

        ],
        desc: 'Портативная переносная система цветной допплерографии М7 отличается самой высокой функциональностью. УЗ-сканер M7 оснащен специальным пакетом опций для кардиологических обследований и программным обеспечением для организации рабочего процесса. Является идеальным выбором для профессионалов, ставящих качество'
      },

      {
        id: 3,
        title: 'Hitachi Arietta 850',
        brand: './img/image/brand.png',
        link: '#!',
        price: { old: '10 000 000 ₽', current: '8 000 000 ₽' },
        sale: '20%',
        size_sale: '120 000  ₽',
        stickers: [
          './img/icon/1.png',
          './img/icon/2.png',
          './img/icon/3.png'
        ],
        property: [
          { label: 'Вид оборудования', value: 'УЗИ аппарат' },
          { label: 'Производитель', value: 'Mindray' },
          { label: 'Тип', value: 'Портативный' },
          { label: 'Класс', value: 'Высокий' },
        ],
        img: [
          './img/image/pic2.png',
          './img/image/pic1.png',
          './img/image/pic3.png',
          './img/image/pic4.png',
          './img/image/pic5.png',
        ],
        desc: 'Портативная переносная система цветной допплерографии М7 отличается самой высокой функциональностью. УЗ-сканер M7 оснащен специальным пакетом опций для кардиологических обследований и программным обеспечением для организации рабочего процесса. Является идеальным выбором для профессионалов, ставящих качество'
      },

      {
        id: 4,
        title: 'Ультразвуковая диагностическая система Mindray DC-60 Exp',
        brand: './img/image/brand.png',
        link: '#!',
        price: { old: '', current: '5 000 000 ₽' },
        sale: '20%',
        size_sale: '1 120 900 ₽',
        stickers: [
          './img/icon/3.png',
          './img/icon/2.png'
        ],
        property: [
          { label: 'Вид оборудования', value: 'УЗИ аппарат' },
          { label: 'Производитель', value: 'Mindray' },
          { label: 'Тип', value: 'Портативный' },
          { label: 'Класс', value: 'Высокий' },
        ],
        img: [
          './img/image/pic1.png',
          './img/image/pic2.png',
          './img/image/pic4.png',
          './img/image/pic5.png',
        ],
        desc: ''
      },

      {
        id: 5,
        title: 'УЗИ аппарат Mindray M5 new ',
        brand: './img/image/brand.png',
        link: '#!',
        price: { old: '11 000 000 ₽', current: '9 000 000 ₽' },
        size_sale: '',
        stickers: [
          './img/icon/2.png',
          './img/icon/1.png',
          './img/icon/3.png'
        ],
        property: [
          { label: 'Вид оборудования', value: 'УЗИ аппарат' },
          { label: 'Производитель', value: 'Mindray' },
          { label: 'Тип', value: 'Портативный' },
          { label: 'Класс', value: 'Высокий' },
        ],
        img: [
          './img/image/pic4.png',
          './img/image/pic5.png',
          './img/image/pic1.png',
          './img/image/pic2.png',
          './img/image/pic3.png',

        ],
        desc: 'Портативная переносная система цветной допплерографии М7 отличается самой высокой функциональностью. УЗ-сканер M7 оснащен специальным пакетом опций для кардиологических обследований и программным обеспечением для организации рабочего процесса. Является идеальным выбором для профессионалов, ставящих качество'
      },
      {
        id: 6,
        title: 'УЗИ аппарат Mindray M5 new ',
        brand: './img/image/brand.png',
        link: '#!',
        price: { old: '', current: '9 000 000 ₽' },
        sale: '20%',
        size_sale: '1 900 ₽',
        stickers: [
          './img/icon/1.png',
          './img/icon/3.png'
        ],
        property: [
          { label: 'Вид оборудования', value: 'УЗИ аппарат' },
          { label: 'Производитель', value: 'Mindray' },
          { label: 'Класс', value: 'Высокий' },
        ],
        img: [
          './img/image/pic4.png',
          './img/image/pic5.png',
          './img/image/pic2.png',
          './img/image/pic3.png',

        ],
        desc: 'Портативная переносная система цветной допплерографии М7 отличается самой высокой функциональностью. УЗ-сканер M7 оснащен специальным пакетом опций для кардиологических обследований и программным обеспечением для организации рабочего процесса. Является идеальным выбором для профессионалов, ставящих качество'
      },

      {
        id: 7,
        title: 'Hitachi Arietta 850',
        brand: './img/image/brand.png',
        link: '#!',
        price: { old: '10 000 000 ₽', current: '8 000 000 ₽' },
        sale: '20%',
        size_sale: '1 170 000 ₽',
        stickers: [
          './img/icon/1.png',
          './img/icon/2.png',
          './img/icon/3.png'
        ],
        property: [
          { label: 'Вид оборудования', value: 'УЗИ аппарат' },
          { label: 'Производитель', value: 'Mindray' },
          { label: 'Тип', value: 'Портативный' },
          { label: 'Класс', value: 'Высокий' },
        ],
        img: [
          './img/image/pic2.png',
          './img/image/pic1.png',
          './img/image/pic3.png',
          './img/image/pic4.png',
          './img/image/pic5.png',
        ],
        desc: ''
      },

      {
        id: 8,
        title: 'Ультразвуковая диагностическая система Mindray DC-60 Exp',
        brand: './img/image/brand.png',
        link: '#!',
        price: { old: '7 000 000 ₽', current: '5 000 000 ₽' },
        sale: '20%',
        size_sale: '1 210 000 ₽',
        stickers: [
          './img/icon/3.png',
          './img/icon/1.png',
          './img/icon/2.png'
        ],
        property: [
          { label: 'Производитель', value: 'Mindray' },
          { label: 'Тип', value: 'Портативный' },
          { label: 'Класс', value: 'Высокий' },
        ],
        img: [
          './img/image/pic1.png',
          './img/image/pic2.png',
          './img/image/pic3.png',
        ],
        desc: 'Портативная переносная система цветной допплерографии М7 отличается самой высокой '
      },

      {
        id: 9,
        title: 'УЗИ аппарат Mindray M5 new ',
        brand: './img/image/brand.png',
        link: '#!',
        price: { old: '11 000 000 ₽', current: '9 000 000 ₽' },
        size_sale: '',
        stickers: [
          './img/icon/2.png',
        ],
        property: [
          { label: 'Вид оборудования', value: 'УЗИ аппарат' },
          { label: 'Производитель', value: 'Mindray' },
          { label: 'Тип', value: 'Портативный' },
          { label: 'Класс', value: 'Высокий' },
        ],
        img: [
          './img/image/pic4.png',
          './img/image/pic5.png',
          './img/image/pic1.png',

          './img/image/pic3.png',

        ],
        desc: ''
      },

      {
        id: 10,
        title: 'Ультразвуковая диагностическая система Mindray DC-60 Exp',
        brand: './img/image/brand.png',
        link: '#!',
        price: { old: '7 000 000 ₽', current: '5 000 000 ₽' },
        sale: '20%',
        size_sale: '2 100 000',
        stickers: [
          './img/icon/3.png',
          './img/icon/1.png',
          './img/icon/2.png'
        ],
        property: [
          { label: 'Вид оборудования', value: 'УЗИ аппарат' },
          { label: 'Производитель', value: 'Mindray' },
          { label: 'Тип', value: 'Портативный' },
          { label: 'Класс', value: 'Высокий' },
        ],
        img: [
          './img/image/pic1.png',
          './img/image/pic2.png',
          './img/image/pic3.png',
          './img/image/pic4.png',
          './img/image/pic5.png',
        ],
        desc: 'Портативнавящих качество'
      },

      {
        id: 11,
        title: 'УЗИ аппарат Mindray M5 new ',
        brand: './img/image/brand.png',
        link: '#!',
        price: { old: '11 000 000 ₽', current: '9 000 000 ₽' },
        sale: '20%',
        size_sale: '2 170 000',
        stickers: [
          './img/icon/2.png',
          './img/icon/1.png',
          './img/icon/3.png'
        ],
        property: [
          { label: 'Вид оборудования', value: 'УЗИ аппарат' },
          { label: 'Производитель', value: 'Mindray' },
          { label: 'Тип', value: 'Портативный' },
          { label: 'Класс', value: 'Высокий' },
        ],
        img: [
          './img/image/pic4.png',
          './img/image/pic5.png',
          './img/image/pic1.png',
          './img/image/pic2.png',
          './img/image/pic3.png',

        ], desc: 'Портативная переносная система цветной допплерографии М7 отличается самой высокой о'
      }
    ]
  }

  getMore = (count) => {
    const ProductList = this.testData.products.slice(0, count);
    return new Promise((resolve, reject) => {
      setTimeout(() => {
        if (Math.random() > 0.80) {
          resolve('error');
        } else {
          resolve(ProductList);
        }
      }, 700);
    });
  }

  getProduct = (id) => {
    const product = this.testData.products.find((item) => item.id == id);
    return new Promise((resolve, reject) => {
      setTimeout(() => {
        if (Math.random() > 0.80) {
          resolve('error');
        } else {
          resolve([product]);
        }
      }, 700);
    });
  }

  getData(data) {
    return new Promise((resolve, reject) => {
      setTimeout(() => {
        if (Math.random() > 0.80) {
          resolve('error');
        } else {
          resolve(this.testData[data]);
        }
      }, 700);
    });
  }
}

class Render {
  constructor($parent = null) {
    //this.$parent = $parent;
    this.declForTotalFindedItem = ['', 'а', 'ов'];
    //this.spinnerText = '';
  }

  renderProductListLoader = ($parent) => {
    this._render($parent, this.getProductListLoaderHtml);
  }
  renderProductListError = ($parent) => {
    this._render($parent, this.getProductListErrorHtml);
  }

  renderProductCards = ($parent, cards) => {
    this._render($parent, this.getProductCardHtml, false, cards);
  }

  renderModalContent = ($parent, content) => {
    this._render($parent, this.getQuickModalContentHtml, false, content);
  }

  //Методы отресовки элементов


  //разметка

  getProductListLoaderHtml = () => {
    return (/*html */`
    <div data-loader class="product-loader">
      <span class="product-loader__message">Загружаю</span>
    </div>
    `)
  }
  getProductListErrorHtml = () => {
    return (/*html */`
      <div data-error class="product-error">
        <div class="product-error__content">
          <img class="product-error__icon" src="./img/icon/broken-robot.svg" alt="">
          <span class="product-error__message">Упс! Что то пошло не так, перезагрузите сраницу!</span>
        </div>
      </div>
    `)
  }

  getProductCardHtml = (card) => {

    const { id, title, property, img, link, price, brand, sale, stickers } = card;
    const propertyHtml = this.getListHtml(this.getPropertyHtml, property);
    const picHtml = this.getListHtml(this.getProductPicHtml, img);
    const dotsHtml = this.getListHtml(this.getProductdotsHtml, img);
    const saleHtml = sale ? this.getProductSaleStickerHtml(sale) : '';
    const stickersHtml = stickers ? this.getListHtml(this.getProductStickerHtml, stickers) : '';
    return (/*html */`
      <div data-id="${id}" class="product-card">
        <div class="product-card__bg">
          <ul class="product-card__property property">
            ${propertyHtml}
          </ul>
        </div>

        <div class="product-card__inner">
          <div class="product-card__preveiw">
            <div class="product-card__slider">
              ${picHtml}
            </div>
            <div class="product-card__dots">
              ${dotsHtml}
            </div>
          </div>
          <h2 class="product-card__title">
            <a class="product-card__link" href="${link}">
              ${title}
            </a>
          </h2>

          <div class="product-card__price">
            <p class="product-card__price-old">${price.old}</p>
            <p class="product-card__price-new">${price.current}</p>
          </div>

          <div class="product-card__nav">
            <a href="${link}" class="product-card__more">Подробнее</a>
            <button class="product-card__btn btn">Получить КП</button>
          </div>


        </div>
        <span class="product-card__brand sticker-brand">
          <img class="sticker-brand__img" src="${brand}" alt="brand">
        </span>

        <div class="product-card__stickers">
          ${saleHtml}
          ${stickersHtml}
        </div>

        <div class="product-card__icon-btns">
          <span data-quick-view class="icon-btn eye"></span>
          <span class="icon-btn heart active"></span>
          <span class="icon-btn graph"></span>
        </div>

    </div>
    `
    )

  }

  getPropertyHtml = (item) => {
    const { label, value } = item
    return (/*html */`
    <li class="property__item">
      <span class="property__label">${label}</span>
      <span class="property__dots"></span>
      <span class="property__value">${value}</span>
    </li>
    `
    )
  }

  getProductPicHtml = (img, idx) => {
    const cls = idx === 0 ? 'product-card__pic active' : 'product-card__pic'
    return (/*html */`
      <img class="${cls}" src="${img}" alt="product"/>
    `
    )
  }

  getProductdotsHtml = (img, idx) => {
    const cls = idx === 0 ? 'product-card__dot active' : 'product-card__dot'
    return (/*html */`
     <span class="${cls}" class="product-card__dot"></span>
    `
    )
  }

  getProductSaleStickerHtml = (sizeSale) => {
    return (/*html */`
      <span class="product-card__sale sticker-sale">
        скидка -${sizeSale}
      </span>
   `
    )
  }

  getProductStickerHtml = (img) => {
    return (/*html */`
      <span class="product-card__sticker sticker">
        <img class="sticker__pic" src="${img}" alt="">
      </span>
   `
    )
  }



  getModalSlidesHtml = (img, idx) => {
    const cls = idx === 0 ? 'quick-view-slider__slide active' : 'quick-view-slider__slide'
    return (/*html */`
      <div class="${cls}">
        <img src="${img}" alt="product" class="quick-view-slider__pic">
      </div>
    `
    )
  }


  getModalSlidesdotsHtml = (img, idx) => {
    const cls = idx === 0 ? 'quick-view-slider__dot active' : 'quick-view-slider__dot'
    return (/*html */`
      <div class="${cls}">
        <img src="${img}" alt="product" class="quick-view-slider__pic">
      </div>
    `
    )
  }

  getQuickModalContentHtml = (content) => {
    const { id, title, img, sale, stickers, brand, price, siza_sale, desc, property, link } = content
    const sliders = this.getListHtml(this.getModalSlidesHtml, img);
    const dots = this.getListHtml(this.getModalSlidesdotsHtml, img);
    const stickersHtml = this.getListHtml(this.getProductStickerHtml, stickers);
    const propertyHtml = this.getListHtml(this.getPropertyHtml, property);
    const saleSticker = sale ? this.getProductSaleStickerHtml(sale) : '';


    return (/*html */`
    <div class="quick-view__content">
            <div class="quick-view__coll">
              <div class="quick-view-slider">
                <div class="quick-view-slider__slides">
                 ${sliders}
                </div>

                <div class="quick-view-slider__dots">
                 ${dots}
                </div>

              </div>
              <div class="quick-view__stickers">
                ${saleSticker}
                ${stickersHtml}
              </div>

            </div>
            <div class="quick-view__coll">
              <div class="quick-view__price-tag">
                <div class="quick-view__brand">
                  <img class="sticker-brand__img" src="${brand}" alt="brand">
                </div>


                <div class="quick-view__price">
                  <p class="quick-view__price-old">${price.old}</p>
                  <p class="quick-view__price-new">${price.current}</p>
                </div>

                <div class="quick-view-sale">
                  <span class="quick-view-sale__label">Вы экономите:</span>
                  <span class="quick-view-sale__value">${siza_sale}</span>
                </div>
                <button class="quick-view__btn btn">Получить КП</button>
                <div class="quick-view-actions">
                  <span class="quick-view-actions__item heart">В избранное</span>
                  <span class="quick-view-actions__item graph">Сравнить</span>
                </div>

              </div>

              <div class="quick-view__info">
                <div class="quick-view__desc">
                  ${desc}
                </div>
              </div>

              <div class="quick-view__property">
                <ul class="property">
                ${propertyHtml}
                </ul>
              </div>

            </div>



          </div>

          <div class="quick-view__bottom">
            <p class="quick-view__product-title">${title}</p>

            <a href="${link}" class="quick-view__more btn">Подробнее</a>
          </div>
    `)
  }
  getListHtml = (getHtmlFn, arr) => {
    let list = '';
    arr.forEach((item, idx) => {

      list += getHtmlFn(item, idx);
    })

    return list;
  }


  //Общая функция отрисовки
  _render = ($parent, getHtmlMarkup, argument = false, array = false, where = 'beforeend') => {
    let markupAsStr = '';
    if (!$parent) {
      return;
    }


    if (array) {
      array.forEach((item) => {
        markupAsStr = markupAsStr + getHtmlMarkup(item);
      })
    }
    if (!array) {
      markupAsStr = getHtmlMarkup(argument);
    }
    $parent.insertAdjacentHTML(where, markupAsStr);
  }

  //Методы удаление элементов

  clearParent = ($parent = this.$parent) => {
    if (!$parent) {
      return;
    }
    $parent.innerHTML = '';
  }

  delete = ($el) => {
    if (!$el) {
      return;
    }
    $el.remove()
  }

  getDeclOfNum(number, decl) {
    const cases = [2, 0, 1, 1, 1, 2];
    return decl[(number % 100 > 4 && number % 100 < 20) ? 2 : cases[(number % 10 < 5) ? number % 10 : 5]];
  }

  getTextWithIllumination = (str, text) => {
    const reg = new RegExp(`${str}`, 'gi')
    const illuminationStr = /*html*/`<span
    class="result-card__light">${str}</span>`
    return text.replace(reg, illuminationStr);
  }

}

class Sort {
  constructor() {
    this.init()
  }

  init = () => {
    this.$sortItemList = document.querySelectorAll('[data-sort]');
    this.$productList = document.querySelector('[data-product-list]');
    this.listeners()
  }
  closeSortPopup = ($sort) => {
    const $popup = $sort.querySelector('[data-sort-popup]');
    const $arrow = $sort.querySelector('[data-arrow]');
    $arrow.classList.remove('up');
    $popup.classList.remove('open');
    $sort.dataset.sort = 'close';
  }
  closeSortPopupAll = () => {
    this.$sortItemList.forEach(($item => {
      this.closeSortPopup($item);
    }))

  };
  openSortPopup = ($sort) => {

    const $popup = $sort.querySelector('[data-sort-popup]');
    const $arrow = $sort.querySelector('[data-arrow]');

    this.closeSortPopupAll();
    if (!$popup) return;
    $popup.classList.add('open');
    $sort.dataset.sort = 'open';
    $arrow.classList.add('up');
  };
  toggleSortPopup = ($sortHead) => {
    const $sort = $sortHead.closest('[data-sort]');
    if (!$sort) {
      this.closeSortPopupAll();
      return
    }
    if ($sort.dataset.sort === 'close') {
      this.openSortPopup($sort);
    } else {
      this.closeSortPopupAll($sort);
    }
  }

  changeSortValue = async ($input) => {
    const value = $input.dataset.radio;
    const $sort = $input.closest('[data-sort]');
    const $value = $sort.querySelector('[data-value]');
    $value.innerHTML = value;
    this.closeSortPopup($sort);

    render.renderProductListLoader(this.$productList)

    const res = await service.getData('products');


    if (res === 'error') {
      render.clearParent(this.$productList);
      this.$productList.innerHTML = '<div class="product-card"></div>'
      render.renderProductListError(this.$productList);
    } else {
      render.clearParent(this.$productList);
      render.renderProductCards(this.$productList, res)
    }


  }


  inputHandler = (e) => {
    this.changeSortValue(e.target);
  }

  clickHandler = (e) => {
    this.toggleSortPopup(e.target);
  }


  listeners = () => {
    document.addEventListener('click', this.clickHandler);
    document.addEventListener('input', this.inputHandler);
  }
}

class Pagination {
  constructor() {
    this.$productList = document.querySelector('[data-product-list]')
    this.moreBtn = document.querySelector('[data-more]');
    this.init();
  }

  init = () => {
    this.listeners();
  }

  downloadMore = async () => {
    const error = this.$productList.querySelector('[data-error]');
    if (error) return;
    const count = this.moreBtn.dataset.more;

    render.renderProductListLoader(this.$productList);
    const loader = this.$productList.querySelector('[data-loader]');

    const res = await service.getMore(count);

    if (res === 'error') {
      render.clearParent(this.$productList);
      this.$productList.innerHTML = '<div class="product-card"></div>'
      render.renderProductListError(this.$productList);
    } else {

      render.delete(loader);
      render.renderProductCards(this.$productList, res)
    }

  }

  clickHandler = () => {

  }
  listeners = () => {

    if (this.moreBtn) {
      this.moreBtn.addEventListener('click', this.downloadMore)
    }
  }
}

class QuickView {
  constructor() {
    this.$modal = document.querySelector('#quickView');
    this.init();
  }

  init = () => {
    if (!this.$modal) return;
    this.$main = this.$modal.querySelector('[data-main]');
    this.$body = document.querySelector('body');
    this.listeners()
  }

  open = async ($btn) => {
    const $product = $btn.closest('[ data-id]')
    const id = $product.dataset.id;
    this.$modal.classList.add('open');
    this.$body.classList.add('no-scroll');
    render.clearParent(this.$main);
    render.renderProductListLoader(this.$main);
    const res = await service.getProduct(id);
    if (res == 'error') {
      render.clearParent(this.$main);
      render.renderProductListError(this.$main);
    } else {
      render.clearParent(this.$main);
      render.renderModalContent(this.$main, res);
    }
  }

  close = () => {
    this.$modal.classList.remove('open');
    this.$body.classList.remove('no-scroll');
  }

  clickHandler = (e) => {
    if (e.target.closest('[data-quick-view]')) {
      this.open(e.target.closest('[data-quick-view]'))
    }

    if (e.target.hasAttribute('data-close')) {
      this.close()
    }
  }

  listeners = () => {
    document.addEventListener('click', this.clickHandler)
  }
}


const service = new Service();
const render = new Render();
const sort = new Sort();
const pagination = new Pagination();
const quickView = new QuickView();